# Discord RPG 商店機器人 v2.1

一個功能完整的Discord RPG商店機器人，支援商店系統、庫存管理、背包系統、角色卡、簽到獎勵等功能。

## 🆕 v2.1 重大更新

- 📦 **完整庫存系統** - 商品可設定庫存數量，支援無限庫存
- 🛒 **購買數量選擇** - 玩家可一次購買多個商品
- 📊 **庫存顯示** - 即時顯示商品剩餘庫存
- 🚫 **庫存控制** - 庫存不足時自動隱藏商品，無法購買
- 🔄 **補貨功能** - 商店主可為商品補充庫存

## 🆕 v2.0 重大更新

- 🏦 **伺服器層級的貨幣系統** - 管理員統一創建貨幣，所有商店共用
- 🏪 **自定義商店ID** - 創建商店時可以自己設定好記的ID
- 💰 **管理員金錢管理** - 添加、移除、查看玩家餘額
- 🌐 **跨伺服器支持** - 同一用戶在不同伺服器有獨立數據

詳細更新內容請查看 [UPDATE_V2.md](UPDATE_V2.md)

## ✨ 主要功能

### 💎 貨幣系統（v2.0新增）
- ✅ 伺服器管理員創建和管理貨幣
- ✅ 支援多種貨幣（金幣、鑽石、積分等）
- ✅ 每種貨幣可自定義名稱、符號、描述
- ✅ 簽到時可選擇要獲得的貨幣類型
- ✅ 管理員可添加/移除玩家的金錢

### 🏪 商店系統
- ✅ 用戶可創建多個商店（可自定義商店ID）
- ✅ 自定義商店名稱、橫幅圖片
- ✅ 商品可設置：名稱、價格、類別、描述、圖片
- ✅ **庫存管理**：設定商品庫存數量，支援無限庫存（-1）
- ✅ **庫存顯示**：商店列表、購買選單即時顯示剩餘庫存
- ✅ **自動管理**：購買後自動扣除庫存，售罄商品自動隱藏
- ✅ **補貨功能**：商店主可隨時為商品補充庫存
- ✅ 商品屬性：可使用/不可使用、可轉售/不可轉售、消耗品/永久物品、非賣品
- ✅ 使用物品時可顯示自定義描述
- ✅ 商店瀏覽界面帶分頁功能

### 🎒 背包系統
- ✅ 每個用戶都有獨立的背包和多種貨幣餘額
- ✅ 可按類別篩選物品
- ✅ 使用物品功能（消耗品會減少數量，永久物品可重複使用）
- ✅ 物品詳細信息顯示

### ⚔️ 角色系統
- ✅ 創建RPG角色卡
- ✅ 可自定義的屬性：HP、MP、攻擊力、防禦力、等級、經驗值
- ✅ 精美的角色卡顯示界面，帶血量/魔力條

### 💰 經濟系統
- ✅ 每日簽到獲得獎勵（可指定貨幣類型）
- ✅ 連續簽到記錄
- ✅ 身份組收入加成系統（可為不同貨幣設置不同加成）
- ✅ 玩家之間可以贈送金幣
- ✅ 管理員工具：添加金錢、移除金錢、查看餘額

## 📦 安裝說明

**詳細的安裝步驟請查看 [INSTALLATION.md](INSTALLATION.md)**

### 快速開始

1. **安裝Python依賴**
```bash
pip install -r requirements.txt
```

2. **檢查安裝**
```bash
python check_setup.py
```

3. **設置Discord Bot**
   - 前往 [Discord Developer Portal](https://discord.com/developers/applications)
   - 創建新應用程式
   - 在 "Bot" 頁面創建機器人
   - 複製 Bot Token
   - 開啟必要的 Intents（MESSAGE CONTENT, SERVER MEMBERS）
   - 在 "OAuth2" > "URL Generator" 選擇：
     - Scopes: `bot`, `applications.commands`
     - Bot Permissions: `Administrator` 或所需的權限

4. **配置環境變數**
```bash
cp .env.example .env
# 編輯 .env 文件，填入你的 DISCORD_TOKEN
```

5. **運行機器人**
```bash
python bot.py
```

## 🚀 Railway 部署

**詳細的部署步驟請查看 [RAILWAY_DEPLOY.md](RAILWAY_DEPLOY.md)**  
**遇到問題請查看 [TROUBLESHOOTING.md](TROUBLESHOOTING.md)**

### 快速部署

1. 推送代碼到GitHub
2. 在Railway創建新項目
3. 連接GitHub repository
4. 設置環境變數 `DISCORD_TOKEN`
5. 自動部署完成

## 📖 指令列表

### 💎 貨幣管理（管理員）
- `/創建貨幣` - 創建新貨幣類型
- `/貨幣列表` - 查看所有可用貨幣
- `/刪除貨幣 <貨幣id>` - 刪除貨幣（謹慎使用）

### 🏪 商店系統
- `/創建商店` - 創建商店（可自定義ID）
- `/我的商店` - 查看你擁有的所有商店
- `/添加商品 <商店id>` - 向商店添加商品（✨ 可設定庫存數量）
- `/查看商店 <用戶> <商店id>` - 查看某個商店（✨ 顯示庫存狀態）
- `/刪除商店 <商店id>` - 刪除你的商店
- `/補貨 <商店id> <商品編號> <數量>` - 為商品補充庫存 ✨ NEW
- `/商品設置 <商店id> <商品編號>` - 設置商品屬性（可使用、可轉售、消耗品）
- `/修改使用描述 <商店id> <商品編號> <描述>` - 修改物品使用時的描述

### 🎒 背包系統
- `/背包` - 查看你的背包和所有貨幣餘額
  - 在背包界面可以：
    - ✨ 使用物品
    - 📁 切換類別查看
    - ◀️▶️ 翻頁

### ⚔️ 角色系統
- `/創建角色` - 創建你的RPG角色
- `/角色卡 [用戶]` - 查看角色信息（可查看其他人）

### 💰 經濟系統
- `/簽到 [貨幣id]` - 每日簽到獲得獎勵（可指定貨幣）
- `/贈送金幣 <用戶> <貨幣id> <金額>` - 贈送金幣給其他玩家
- `/設置簽到收入 <身份組> <貨幣id> <金額>` - 設置身份組收入（管理員）
- `/收入身份組列表` - 查看所有收入身份組
- `/添加金錢 <用戶> <貨幣id> <金額>` - 給玩家添加金錢（管理員）
- `/移除金錢 <用戶> <貨幣id> <金額>` - 移除玩家金錢（管理員）
- `/查看餘額 <用戶>` - 查看玩家餘額（管理員）

### 👑 管理員管理
- `/添加管理員 <用戶>` - 設置機器人管理員（需Discord管理員權限）
- `/移除管理員 <用戶>` - 移除機器人管理員（需Discord管理員權限）
- `/管理員列表` - 查看所有機器人管理員

### 🔧 其他
- `/幫助` - 顯示所有可用指令

## 🎮 使用範例

### 第一次設置（管理員必做）
```
1. 創建貨幣系統
/創建貨幣
→ 貨幣ID: gold（英文，用於系統識別）
→ 貨幣名稱: 金幣（顯示給玩家的名稱）
→ 符號: 💰
→ 描述: 基礎貨幣

/創建貨幣
→ 貨幣ID: diamond
→ 貨幣名稱: 鑽石
→ 符號: 💎
→ 描述: 高級貨幣

2. 設置身份組收入
/設置簽到收入 @VIP身份組 gold 500
/設置簽到收入 @VIP身份組 diamond 100
/設置簽到收入 @月費會員 gold 300
```

### 創建商店流程（玩家）
```
1. 創建商店
/創建商店
→ 商店ID: magic_shop（自己設定，英文+數字+下劃線）
→ 商店名稱: 魔法道具店
→ 橫幅URL: (可選)
→ 描述: 販賣各種魔法道具

2. 查看商店
/我的商店
→ 看到: magic_shop

3. 添加商品（✨ v2.1 新增庫存設定）
/添加商品 magic_shop
→ 選擇貨幣: 💰 金幣
→ 商品名稱: 治療藥水
→ 價格: 50
→ 庫存數量: 100（輸入 -1 表示無限庫存）✨ NEW
→ 類別: 消耗品
→ 描述: 恢復50點生命值

4. 設置商品屬性
/商品設置 magic_shop item_1
→ 點擊按鈕切換：
   - 可使用 - 玩家是否能使用此物品
   - 可轉售 - 玩家是否能轉售此物品
   - 消耗型 - 使用後是否消失（關閉則可重複使用）
→ 查看庫存狀態 📦 ✨ NEW

5. 補充庫存（✨ v2.1 新增）
/補貨 magic_shop item_1 50
→ 為治療藥水補充 50 個庫存
→ 系統會顯示補貨前後的庫存對比

6. 設置使用效果
/修改使用描述 magic_shop item_1 你喝下了治療藥水，感覺身體充滿了活力！HP+50
```

### 日常使用（玩家）
```
1. 每日簽到
/簽到 gold
→ 獲得金幣（基礎獎勵+身份組加成）

/簽到 diamond
→ 獲得鑽石

2. 購買物品（✨ v2.1 更新）
/查看商店 @商店主 magic_shop
→ 查看商品列表（顯示庫存狀態）✨
→ 點擊 🛒 購買按鈕
→ 選擇要購買的商品（售罄商品不會顯示）✨
→ 輸入購買數量（系統會檢查庫存是否足夠）✨
→ 確認購買（自動扣除庫存）✨

3. 查看背包
/背包
→ 查看所有貨幣餘額
→ 查看所有物品
→ 點擊 ✨ 使用物品
→ 點擊 📁 切換類別

4. 使用物品
→ 選擇要使用的物品
→ 看到你設置的使用描述
→ 消耗品會減少數量，永久物品保留

5. 轉帳給朋友
/贈送金幣 @朋友 gold 100
→ 轉100金幣給朋友
```

### 管理功能（管理員）
```
1. 查看玩家餘額
/查看餘額 @玩家
→ 查看該玩家所有貨幣

2. 添加金錢（例如活動獎勵）
/添加金錢 @優勝者 diamond 1000
→ 給優勝者1000鑽石

3. 移除金錢（例如懲罰）
/移除金錢 @違規者 gold 500
→ 從違規者移除500金幣（餘額不足則歸零）

4. 查看所有貨幣
/貨幣列表
→ 查看伺服器的所有貨幣

5. 查看收入設置
/收入身份組列表
→ 查看所有身份組的收入設置
```

## 💾 數據存儲

所有數據存儲在 `data/` 目錄下的JSON文件：
- `guilds.json` - 伺服器數據（貨幣、收入身份組）
- `shops.json` - 商店數據（包含商品庫存信息）
- `users.json` - 用戶數據（餘額、背包、角色）
- `characters.json` - 角色數據
- `checkins.json` - 簽到記錄

**注意**: Railway部署時，數據會在容器重啟時丟失。如需持久化存儲，建議：
1. 使用Railway的持久存儲卷（Volume）
2. 或連接外部數據庫（如MongoDB）

## 🎨 特色功能

### 1. 完整庫存系統（v2.1 新增）✨

**庫存設定**：
- 添加商品時可設定初始庫存數量
- 支援無限庫存（輸入 -1）
- 支援限量商品（輸入具體數量）

**購買控制**：
- 玩家可一次購買多個商品
- 系統自動檢查庫存是否足夠
- 庫存不足時無法購買
- 購買後自動扣除相應數量

**庫存顯示**：
- 商店列表實時顯示剩餘庫存
- 購買選單顯示庫存狀態
- 商品設置頁面顯示當前庫存
- 三種顯示狀態：
  - 📦 無限 ♾️（無限庫存）
  - 📦 剩餘: X 個（有庫存）
  - ❌ 已售罄（無庫存）

**庫存管理**：
- 商店主可隨時補貨
- 補貨時顯示前後對比
- 售罄商品自動從購買選單隱藏
- 無限庫存商品無需補貨

**使用範例**：
```
限量商品：稀有寵物蛋（庫存：10）
普通商品：治療藥水（庫存：100）
暢銷商品：魔法卷軸（庫存：無限）
活動限定：聖誕禮包（庫存：50）
```

### 2. 伺服器層級的貨幣系統（v2.0）
管理員統一創建貨幣，所有商店都使用這些貨幣：
- **統一性**：避免混亂，玩家清楚知道有哪些貨幣
- **靈活性**：可創建多種貨幣用於不同目的
- **可控性**：管理員可以統一管理貨幣發行

範例貨幣設置：
- 💰 金幣 (gold) - 基礎貨幣，簽到獲得
- 💎 鑽石 (diamond) - 高級貨幣，活動獎勵
- ⭐ 積分 (point) - 任務貨幣，完成任務獲得
- 🎫 代幣 (token) - 活動貨幣，特殊活動使用

### 3. 自定義商店ID（v2.0）
創建商店時可以設定好記的ID：
- ✅ magic_shop（魔法商店）
- ✅ weapon_store（武器店）
- ✅ potion_house（藥水小屋）
- ❌ 123shop（不能數字開頭）
- ❌ my shop（不能有空格）

### 4. 靈活的物品系統
- **非賣品**: 設置價格為0，只展示不出售
- **永久物品**: 關閉"消耗型"，物品使用後不消失
- **自定義使用描述**: 每個物品都能設置獨特的使用效果描述
- **物品分類**: 自由設置類別，背包可按類別篩選
- **庫存控制**: 可設定商品數量，售罄自動下架 ✨ NEW

### 5. 身份組經濟系統（v2.0）
- 管理員可為不同身份組設置不同貨幣的收入
- 玩家簽到時自動計算所有身份組的加成
- 支援多個身份組的收入累加

範例設置：
```
VIP身份組:
  - 金幣: +500
  - 鑽石: +100

月費會員:
  - 金幣: +300
  - 鑽石: +50

普通會員:
  - 金幣: +100（基礎獎勵）
```

### 6. 互動式界面
- 使用Discord的按鈕和選擇菜單
- 分頁瀏覽，避免信息過載
- Modal表單輸入，體驗更好
- 下拉式選單選擇貨幣類型
- 購買數量輸入，支援批量購買 ✨ NEW

## 🔧 自定義開發

### 添加新的角色屬性
在 `CreateCharacterModal` 類中添加新的 `TextInput`：
```python
strength = discord.ui.TextInput(
    label='力量',
    placeholder='例如: 10',
    required=True,
    max_length=10
)
```

### 添加新的商品屬性
在 `AddItemModal` 的 `on_submit` 方法中添加新欄位：
```python
shops[shop_key][self.shop_id]['items'][item_id] = {
    # ... 現有欄位 ...
    "rarity": "普通",  # 新增稀有度
    "level_requirement": 1,  # 新增等級需求
    "stock": stock,  # v2.1 已包含庫存
}
```

### 創建新的貨幣類型
管理員使用 `/創建貨幣` 即可，無需修改代碼

## ⚠️ 注意事項

1. **Token安全**: 絕對不要將 `.env` 文件或 Discord Token 提交到公開的repository
2. **數據備份**: 定期備份 `data/` 目錄
3. **權限設置**: 確保機器人有足夠的權限（建議使用Administrator或自行配置所需權限）
4. **Railway限制**: 
   - 免費方案有使用時數限制
   - 容器重啟會丟失本地文件
   - 建議升級到付費方案或使用外部數據庫
5. **版本升級**: 
   - v2.1 與 v2.0 完全兼容（只需更新代碼）
   - v2.0 與 v1.0 數據不兼容，升級前請備份數據

## 🐛 問題排查

### VSCode顯示 "Import discord could not be resolved"

這是Pylance的類型檢查警告，**不影響程式運行**。如果你的機器人能正常啟動，可以忽略此警告。

**解決方法**:
1. 確認discord.py已安裝: `pip list | grep discord`
2. 重啟VSCode
3. 選擇正確的Python解釋器 (Ctrl+Shift+P → "Python: Select Interpreter")

### 機器人無法啟動
- 檢查 `DISCORD_TOKEN` 是否正確設置
- 確認網絡連接正常
- 查看控制台錯誤信息
- 運行 `python check_setup.py` 檢查配置

### 斜線指令不顯示
- 確保機器人已被邀請到伺服器
- 檢查機器人是否有 `applications.commands` 權限
- 等待幾分鐘讓Discord同步指令
- 嘗試踢出機器人再重新邀請

### Railway部署失敗
- 查看 [TROUBLESHOOTING.md](TROUBLESHOOTING.md) 獲取詳細的解決方案
- 確認所有必要文件都已推送（Procfile, nixpacks.toml, requirements.txt）
- 檢查Railway的Build Logs和Deploy Logs

### 數據丟失
- Railway重啟會清空容器，導致數據丟失
- 建議定期導出數據或使用外部數據庫
- 考慮使用Railway的Volume功能

### 庫存相關問題 ✨ NEW
- **庫存顯示不正確**: 檢查商品的 `stock` 欄位是否正確保存
- **無法購買**: 確認庫存數量是否足夠，價格是否大於0
- **補貨失敗**: 確認是否為無限庫存商品（-1）
- **庫存變負數**: 這不應該發生，如果發生請報告bug

## 📚 文檔

- [UPDATE_V2.md](UPDATE_V2.md) - v2.0更新說明和完整使用指南
- [INSTALLATION.md](INSTALLATION.md) - 詳細的安裝步驟
- [RAILWAY_DEPLOY.md](RAILWAY_DEPLOY.md) - Railway部署指南
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - 問題排查指南

## 🆕 版本更新歷史

### v2.1 (最新) ✨
- ✅ 完整庫存系統
- ✅ 購買數量選擇
- ✅ 庫存即時顯示
- ✅ 補貨功能
- ✅ 售罄商品自動隱藏

### v2.0
- ✅ 伺服器層級貨幣系統
- ✅ 自定義商店ID
- ✅ 管理員金錢管理工具
- ✅ 多貨幣支援
- ✅ 跨伺服器獨立數據

### v1.0
- ✅ 基礎商店系統
- ✅ 背包系統
- ✅ 角色卡系統
- ✅ 簽到系統

## 📊 v2.1 vs v2.0 vs v1.0 功能對比

| 功能 | v1.0 | v2.0 | v2.1 |
|------|------|------|------|
| 貨幣系統 | 每個商店獨立 | 伺服器統一管理 | 伺服器統一管理 |
| 商店ID | 自動生成 (shop_1) | 用戶自定義 | 用戶自定義 |
| 簽到獎勵 | 固定貨幣 | 可選擇貨幣類型 | 可選擇貨幣類型 |
| 管理工具 | 僅身份組收入 | 添加/移除/查看餘額 | 添加/移除/查看餘額 |
| 數據範圍 | 全局 | 每個伺服器獨立 | 每個伺服器獨立 |
| 貨幣種類 | 單一 | 支援多種 | 支援多種 |
| **庫存系統** | ❌ | ❌ | ✅ **NEW** |
| **購買數量** | ❌ | ❌ | ✅ **NEW** |
| **庫存顯示** | ❌ | ❌ | ✅ **NEW** |
| **補貨功能** | ❌ | ❌ | ✅ **NEW** |

## 📝 授權

此項目為開源項目，可自由修改和使用。

## 🤝 貢獻

歡迎提交Issue和Pull Request！

如果你覺得這個項目有幫助，請給個⭐️！

## 📧 聯繫

如有問題，歡迎在GitHub開Issue討論。

---

祝你使用愉快！ 🎉